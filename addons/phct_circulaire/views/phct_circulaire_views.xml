<odoo>
  <data>
    <record id="view_phct_circulaire_tree" model="ir.ui.view">
      <field name="name">phct.circulaire.tree</field>
      <field name="model">phct.circulaire</field>
      <field name="arch" type="xml">
        <tree string="Circulaires">
          <field name="filename"/>
          <field name="date"/>
          <field name="new_medication_count"/>
          <field name="revised_count"/>
          <field name="not_found_count"/>
          <field name="matched_100_count"/>
          <field name="matched_partial_count"/>
          <field name="ocr_verify_recommended" widget="boolean"/>
        </tree>
      </field>
    </record>

    <record id="view_phct_circulaire_form" model="ir.ui.view">
      <field name="name">phct.circulaire.form</field>
      <field name="model">phct.circulaire</field>
      <field name="arch" type="xml">
        <form string="Circulaire">
          <sheet>
            <group>
              <group>
                <field name="filename"/>
                <field name="circulaire_ref"/>
                <field name="circulaire_number"/>
                <field name="year"/>
                <field name="date"/>
                <field name="pdf_url" widget="url"/>
              </group>
              <group>
                <field name="medications_count" string="Total Medications"/>
                <field name="new_medication_count"/>
                <field name="revised_count"/>
                <field name="not_found_count"/>
                <field name="matched_100_count"/>
                <field name="matched_partial_count"/>
                <field name="ocr_used"/>
                <field name="ocr_verify_recommended" widget="boolean"/>
              </group>
            </group>
            <notebook>
              <page string="Medications">
                <field name="medication_ids">
                  <tree editable="bottom" decoration-success="match_status=='matched' and price_comparison=='equal'" 
                        decoration-warning="match_status=='matched' and price_comparison in ('phct_higher', 'phct_lower')"
                        decoration-muted="match_status=='not_found'">
                    <field name="name"/>
                    <field name="laboratory"/>
                    <field name="price_public"/>
                    <field name="match_status"/>
                    <field name="match_confidence" widget="progressbar"/>
                    <field name="product_id"/>
                    <field name="price_comparison"/>
                    <field name="price_difference" widget="monetary"/>
                    <field name="type"/>
                    <field name="origin"/>
                  </tree>
                </field>
              </page>
              <page string="Parsed JSON">
                <field name="parsed" widget="ace" options="{'mode': 'json'}"/>
              </page>
              <page string="Simplified JSON">
                <field name="simplified" widget="ace" options="{'mode': 'json'}"/>
              </page>
              <page string="Sections">
                <field name="sections_found" widget="ace" options="{'mode': 'json'}"/>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>

    <record id="action_phct_circulaires" model="ir.actions.act_window">
      <field name="name">PHCT Circulaires</field>
      <field name="res_model">phct.circulaire</field>
      <field name="view_mode">tree,form</field>
    </record>

    <menuitem id="menu_phct_root" name="PHCT" sequence="90"/>
    <menuitem id="menu_phct_circulaire" name="Circulaires" parent="menu_phct_root" sequence="10"/>
    <menuitem id="menu_phct_circulaires_action" name="Imported Circulaires" parent="menu_phct_circulaire" action="action_phct_circulaires" sequence="10"/>
    
    <!-- Medications views -->
    <record id="view_phct_circulaire_med_tree" model="ir.ui.view">
      <field name="name">phct.circulaire.med.tree</field>
      <field name="model">phct.circulaire.med</field>
      <field name="arch" type="xml">
        <tree string="Medications" decoration-success="match_status=='matched' and price_comparison=='equal'" 
              decoration-warning="match_status=='matched' and price_comparison in ('phct_higher', 'phct_lower')"
              decoration-muted="match_status=='not_found'">
          <field name="circulaire_display"/>
          <field name="name"/>
          <field name="laboratory"/>
          <field name="price_public"/>
          <field name="match_status"/>
          <field name="match_confidence" widget="progressbar"/>
          <field name="product_id"/>
          <field name="price_comparison"/>
          <field name="price_difference" widget="monetary"/>
          <field name="type"/>
          <field name="origin"/>
        </tree>
      </field>
    </record>

    <record id="view_phct_circulaire_med_form" model="ir.ui.view">
      <field name="name">phct.circulaire.med.form</field>
      <field name="model">phct.circulaire.med</field>
      <field name="arch" type="xml">
        <form string="Medication">
          <header>
            <button name="match_with_product" string="Re-match Product" type="object" class="oe_highlight"/>
            <button name="action_create_product" string="Create New Product" type="object" class="oe_highlight"/>
            <button name="action_update_product" string="Update Matched Product" type="object" class="btn-primary"
                    attrs="{'invisible': [('product_id', '=', False)]}"/>
            <field name="match_status" widget="statusbar" statusbar_visible="not_checked,matched,not_found"/>
          </header>
          <sheet>
            <div class="oe_button_box" name="button_box">
              <button name="action_update_product" type="object" class="oe_stat_button" icon="fa-external-link"
                      attrs="{'invisible': [('product_id', '=', False)]}">
                <field name="product_id" widget="statinfo" string="Linked Product"/>
              </button>
            </div>
            <group>
              <group>
                <field name="circulaire_id"/>
                <field name="circulaire_display"/>
                <field name="code"/>
                <field name="name"/>
                <field name="laboratory"/>
                <field name="type"/>
                <field name="origin"/>
                <field name="specialty"/>
              </group>
              <group>
                <field name="price_wholesale"/>
                <field name="price_pharmacy"/>
                <field name="price_public"/>
                <field name="category"/>
                <field name="margin"/>
              </group>
            </group>
            
            <notebook>
              <page string="Product Matching">
                <group>
                  <group>
                    <field name="product_id" string="Matched Product" readonly="1" 
                           attrs="{'invisible': [('product_id', '=', False)]}"/>
                    <field name="match_status" string="Match Status"/>
                    <field name="match_confidence" widget="progressbar"/>
                  </group>
                  <group>
                    <field name="price_comparison"/>
                    <field name="price_difference" widget="monetary"/>
                  </group>
                </group>
              </page>
              
              <page string="ðŸ” Manual Search">
                <group>
                  <div class="alert alert-info" role="alert">
                    <strong>How to use:</strong>
                    <ol>
                      <li>Type at least 3 characters in the search box below</li>
                      <li>Matching products will appear as tags</li>
                      <li>Use the dropdown to select the correct product</li>
                      <li>The product will be linked automatically</li>
                    </ol>
                  </div>
                </group>
                
                <group string="Step 1: Search Products">
                  <field name="search_term" 
                         force_save="1"
                         placeholder="Type product name, code, or keywords (min 3 chars)..."
                         style="font-size: 14px; min-width: 300px;"/>
                </group>
                
                <group string="Step 2: Review Results" attrs="{'invisible': [('search_results_ids', '=', [])]}">
                  <field name="search_results_ids" 
                         widget="many2many_tags" 
                         nolabel="1"
                         readonly="1"
                         options="{'color_field': 'list_price', 'no_create': True}"/>
                </group>
                
                <group string="Step 3: Select Product">
                  <field name="manual_product_id" 
                         force_save="1"
                         context="{'default_categ_id': 9}"
                         options="{'no_create': True, 'no_quick_create': True}"
                         placeholder="Click to select from search results or type to search all..."/>
                </group>
              </page>
            </notebook>
            
            <group string="Actions Guide">
              <div class="alert alert-info" role="alert">
                <strong>Available Actions:</strong>
                <ul>
                  <li><strong>Re-match Product:</strong> Run auto-matching again (useful after adding new products)</li>
                  <li><strong>Create New Product:</strong> Add this medication as a new product (different dosage/quantity)</li>
                  <li><strong>Update Matched Product:</strong> Edit existing product (fix typos or update prices)</li>
                  <li><strong>Manual Product Selection:</strong> Search and link manually if auto-match is incorrect</li>
                </ul>
              </div>
            </group>
            <group string="Price Update Suggestion" attrs="{'invisible': ['|', ('product_id', '=', False), ('price_comparison', '=', 'equal')]}">
              <div class="alert alert-warning" role="alert">
                <strong>Price difference detected!</strong>
                <ul>
                  <li>PHCT Price: <field name="price_public" readonly="1" nolabel="1" style="display:inline;"/></li>
                  <li>Difference: <field name="price_difference" readonly="1" nolabel="1" style="display:inline;"/> (<field name="price_comparison" readonly="1" nolabel="1" style="display:inline;"/>)</li>
                </ul>
                Click "Update Matched Product" to adjust the product price.
              </div>
            </group>
          </sheet>
        </form>
      </field>
    </record>

    <record id="view_phct_circulaire_med_search" model="ir.ui.view">
      <field name="name">phct.circulaire.med.search</field>
      <field name="model">phct.circulaire.med</field>
      <field name="arch" type="xml">
        <search string="Search Medications">
          <field name="name"/>
          <field name="code"/>
          <field name="laboratory"/>
          <field name="product_id"/>
          <filter string="Matched" name="matched" domain="[('match_status', '=', 'matched')]"/>
          <filter string="Not Found" name="not_found" domain="[('match_status', '=', 'not_found')]"/>
          <filter string="Not Checked" name="not_checked" domain="[('match_status', '=', 'not_checked')]"/>
          <separator/>
          <filter string="PHCT Price Higher" name="phct_higher" domain="[('price_comparison', '=', 'phct_higher')]"/>
          <filter string="PHCT Price Lower" name="phct_lower" domain="[('price_comparison', '=', 'phct_lower')]"/>
          <filter string="Price Equal" name="price_equal" domain="[('price_comparison', '=', 'equal')]"/>
          <group expand="0" string="Group By">
            <filter string="Match Status" name="group_match_status" context="{'group_by': 'match_status'}"/>
            <filter string="Price Comparison" name="group_price_comparison" context="{'group_by': 'price_comparison'}"/>
            <filter string="Circulaire" name="group_circulaire" context="{'group_by': 'circulaire_id'}"/>
            <filter string="Laboratory" name="group_laboratory" context="{'group_by': 'laboratory'}"/>
          </group>
        </search>
      </field>
    </record>

    <record id="action_phct_circulaire_medications" model="ir.actions.act_window">
      <field name="name">Medications</field>
      <field name="res_model">phct.circulaire.med</field>
      <field name="view_mode">tree,form</field>
      <field name="context">{'search_default_matched': 1}</field>
    </record>
    
    <!-- Server action for bulk re-matching unmatched medications -->
    <record id="action_server_rematch_all_unmatched" model="ir.actions.server">
      <field name="name">Re-match All Unmatched Medications</field>
      <field name="model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_view_types">list</field>
      <field name="state">code</field>
      <field name="code">action = model.action_rematch_all_unmatched()</field>
    </record>
    
    <!-- Action for selected medications -->
    <record id="action_server_bulk_rematch_selected" model="ir.actions.server">
      <field name="name">Re-match Selected Medications</field>
      <field name="model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_view_types">list</field>
      <field name="state">code</field>
      <field name="code">action = records.action_bulk_rematch()</field>
    </record>
    
    <!-- Action to create product from medication -->
    <record id="action_server_create_product_from_med" model="ir.actions.server">
      <field name="name">Create Product from Medication</field>
      <field name="model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_view_types">list,form</field>
      <field name="state">code</field>
      <field name="code">
if len(records) == 1:
    action = records.action_create_product()
else:
    raise UserError("Please select only one medication to create a product from.")
      </field>
    </record>
    
    <!-- Action to update matched product -->
    <record id="action_server_update_matched_product" model="ir.actions.server">
      <field name="name">Update Matched Product</field>
      <field name="model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_model_id" ref="model_phct_circulaire_med"/>
      <field name="binding_view_types">list,form</field>
      <field name="state">code</field>
      <field name="code">
if len(records) == 1:
    action = records.action_update_product()
else:
    raise UserError("Please select only one medication to update its product.")
      </field>
    </record>

    <menuitem id="menu_phct_medications_action" name="Medications" parent="menu_phct_circulaire" action="action_phct_circulaire_medications" sequence="20"/>
  </data>
</odoo>
